<html>
  <style>
    .plat { background: black; position: absolute;}
  </style>
  <body>
  
    <div id="bg" style="width:500px; height:500px; background:#eee; border:2px solid black;">
      <img id="player" src="fire_elementalist-pixilart.png" style="position:absolute; left:100px; top:200px">
      <div id="player_origin" style="position:absolute; background: green; left:100px; top:200px; width:4px; height:4px;"></div>

      <div class="plat" style="left:250px; top:300px; height:80px; width: 90px;"> </div>
      <div class="plat" style="left:150px; top:200px; height:80px; width: 90px; "> </div>
      <div class="plat" style="left:190px; top:260px; height:80px; width: 90px; "> </div>
      
    </div>
    <p id="debug"></p>
      
      <script>
        let debug = document.getElementById("debug");
        let state = "starting";
        let originx = 50, originy = 60;
        let playerx = 100;
        let playery = 200;
        let dx = 0;
        let dy = 0;
        let ax = 0;
        let ay = 0;
        let left = 37;
        let up = 38;
        let right = 39;
        let down = 40;

        document.addEventListener("keydown", function(e) {
          if (e.keyCode == left) {
            console.log("left");
            dx -= 1;
          } else if (e.keyCode == right) {
            console.log("right");
            dx += 1;
          } else if (e.keyCode == up && dy > -1 && dy < 1) {
            console.log("up");
            dy -= 15;
            state = "jump!";
          } else if (e.keyCode == down) {
            console.log("down");
            dy += 1;
          }

        });
        
        setInterval (function () { 
        let player = document.getElementById("player");
        let player_origin = document.getElementById("player_origin");
        let newx = playerx;
        let newy = playery;
        if (playery + dy > 500) {
          dy = 0;
          ay = 0;
          newy = 500;
          state = "hit floor";
        } else if (playery + dy < 50) {
          dy = 0;
          ay = 0;
          newy = 50;
          state = "hit ceiling";
        } else {
          newy = playery + dy;
        }
          
        if (playerx + dx > 500) {
          dx = 0;
          ax = 0;
          newx = 500;
          state = "hit right side";
        } else if (playerx + dx < 20) {
          dx = 0;
          ax = 0;
          newx = 20;
          state = "hit left side";
        } else {
          newx = playerx + dx;
        }
        newx = newx + dx;
        if (!collision(newx, newy) || collision(playerx, playery)) {
          playery = newy;
          playerx = newx;
          state = "floating";
        } else if (!collision(newx, playery)) {
          playerx = newx;
          dy = 0;
          ay = 0;
          state = "skating";
        } else if (!collision(playerx, newy)) {
          playery = newy;
          dx = 0;
          ax = 0;
          state = "falling straight down";
        } else {
          dx = 0;
          ax = 0;
          dy = 0;
          ay = 0;
          state = "blocked";
        }
        player.style.left = (playerx - originx) + "px";
        player.style.top = (playery - originy) + "px";
        player_origin.style.left = playerx + "px";
        player_origin.style.top = playery + "px";
        debug.innerText = state + " (" + Math.floor(playerx) + ", " + Math.floor(playery) + ") + (" + Math.floor(dx * 100) / 100 + ", " + Math.floor(dy * 100) / 100 + ")";
        dx = (dx + ax) * 0.9;
        dy = (dy + ay) * 0.9;
        ay = ay + 0.05;
             },50);      
        
        function collision(x, y) {
          let plats = document.getElementsByClassName("plat");
          for (let i = 0; i < plats.length; i++) {
            let plat = plats[i];
            if (inside(x, y, plat.offsetTop, plat.offsetLeft, plat.offsetHeight, plat.offsetWidth)) {
             return true; 
            }
          }
          return false;
        }
        
        function inside(x, y, top, left, width, height) {
          return (x >= left && x <= left + width + 20 &&
                  y >= top && y <= top + height + 30);
        }
    </script>
  
  </body>
  
</html>
