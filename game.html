<html>
  <style>
    .plat { background: black; position: absolute; border-radius: 8px; border: solid grey 2px;}
  </style>
  <body>
  
    <div id="bg" style="width:500px; height:500px; background:#eee; border:2px solid black;">
      <img id="player1" class="solid" src="fire_elementalist-pixilart.png" style="position:absolute; left:100px; top:200px">
      <div id="player1_origin" style="position:absolute; background: green; left:100px; top:200px; width:4px; height:4px;"></div>
      <img id="player2" class="solid" src="fire_elementalist-pixilart.png" style="position:absolute; left:150px; top:200px">
      <div id="player2_origin" style="position:absolute; background: pink; left:150px; top:200px; width:4px; height:4px;"></div>

      <div class="plat solid" style="left:50px; top:210px; height:80px; width: 190px; "> </div>
      <div class="plat" style="left:190px; top:260px; height:80px; width: 90px; "> </div>
      <div class="plat solid" style="left:270px; top:300px; height:80px; width: 90px;"> </div>
      <div class="plat solid" style="left:310px; top:360px; height:80px; width: 90px; "> </div>
      
    </div>
    <p id="player1_debug"></p>
    <p id="player2_debug"></p>
      
      <script>
        class Player {
          constructor(x, y, image_id) {
            this.x = x;
            this.y = y;
            this.id = image_id;
            this.dx = 0;
            this.dy = 0;
            this.ax = 0;
            this.ay = 0;
            this.state = "starting";
          }
        }
        
        let player1 = new Player(100, 200, "player1");
        let player2 = new Player(150, 200, "player2");
        let originx = 50, originy = 62;
        let left = 37;
        let up = 38;
        let right = 39;
        let down = 40;

        document.addEventListener("keydown", function(e) {
          if (e.keyCode == left) {
            console.log("left");
            player1.dx -= 1;
          } else if (e.keyCode == right) {
            console.log("right");
            player1.dx += 1;
          } else if (e.keyCode == up && player1.dy > -1 && player1.dy < 1) {
            console.log("up");
            player1.dy -= 15;
            player1.state = "jump!";
          } else if (e.keyCode == down) {
            console.log("down");
            player1.dy += 1;
          }
          if (e.key == "a") {
            console.log("a");
            player2.dx -= 1;
          } else if (e.key == "d") {
            console.log("d");
            player2.dx += 1;
          } else if (e.key == "w" && player2.dy > -1 && player2.dy < 1) {
            console.log("w");
            player2.dy -= 15;
            player2.state = "jump!";
          } else if (e.keyCode == "s") {
            console.log("s");
            player2.dy += 1;
          }

        });
        
        setInterval (function () {
          playTurn(player1);
          playTurn(player2);
        }, 50);
        
        function playTurn(player) {
          let player_img = document.getElementById(player.id);
          let player_origin = document.getElementById(player.id + "_origin");
          let newx = player.x;
          let newy = player.y;
          if (player.y + player.dy > 510) {
            player.dy = 0;
            player.ay = 0;
            newy = 510;
            player.state = "hit floor";
          } else if (player.y + player.dy < 50) {
            player.dy = 0;
            player.ay = 0;
            newy = 50;
            player.state = "hit ceiling";
          } else {
            newy = player.y + player.dy;
          }
          
          if (player.x + player.dx > 500) {
            player.dx = 0;
            player.ax = 0;
            newx = 500;
            player.state = "hit right side";
          } else if (player.x + player.dx < 20) {
            player.dx = 0;
            player.ax = 0;
            newx = 20;
            player.state = "hit left side";
          } else {
            newx = player.x + player.dx;
          }
          newx = newx + player.dx;
          if (!collision(newx, newy, player_img) 
              /* || collision(player.x, player.y, player_img) */
             ) {
            player.y = newy;
            player.x = newx;
            player.state = "floating";
          } else  if (!collision((player.x + 3 * newx)/4, (player.y + 3 * newy)/4, player_img)) {
            player.y = (3 * player.y + newy)/4;
            player.x = (3 * player.x + newx)/4;
            player.state = "floating";
          } else  if (!collision((player.x + newx)/2, (player.y + newy)/2, player_img)) {
            player.y = (player.y + newy)/2;
            player.x = (player.x + newx)/2;
            player.state = "floating";
          } else  if (!collision((3 * player.x + newx)/4, (3 * player.y + newy)/4, player_img)) {
            player.y = (3 * player.y + newy)/4;
            player.x = (3 * player.x + newx)/4;
            player.state = "floating";
          } else if (!collision(newx, player.y, player_img)) {
            player.x = newx;
            player.dy = 0;
            player.ay = 0;
            player.state = "skating";
          } else if (!collision(player.x, newy, player_img)) {
            player.y = newy;
            player.dx = 0;
            player.ax = 0;
            player.state = "falling straight down";
          } else {
            player.dx = 0;
            player.ax = 0;
            player.dy = 0;
            player.ay = 0;
            state = "blocked";
          }
          player_img.style.left = (player.x - originx) + "px";
          player_img.style.top = (player.y - originy) + "px";
          player_origin.style.left = player.x + "px";
          player_origin.style.top = player.y + "px";
          let debug = document.getElementById(player.id + "_debug");
          debug.innerText = player.state + " (" + Math.floor(player.x) + ", " + Math.floor(player.y) + ") + (" + Math.floor(player.dx * 100) / 100 + ", " + Math.floor(player.dy * 100) / 100 + ")";
          player.dx = (player.dx + player.ax) * 0.9;
          player.dy = (player.dy + player.ay) * 0.9;
          player.ay = player.ay + 0.05;
        }      
        
        function collision(x, y, myself) {
          let solids = document.getElementsByClassName("solid");
          for (let i = 0; i < solids.length; i++) {
            let solid = solids[i];
            if (solid != myself &&
                inside(x, y, solid.offsetTop, solid.offsetLeft, solid.offsetWidth, solid.offsetHeight)) {
             return true; 
            }
          }
          return false;
        }
        
        function inside(x, y, top, left, width, height) {
          return (x >= left && x - 20 <= left + width &&
                  y >= top && y - 20 <= top + height);
        }
    </script>
  
  </body>
  
</html>
